# 📄 PROMA 배포

### IDE
- Visul Studio Code 1.66.0
- IntelliJ IDEA 2021.3.1

### Frontend
- React 17.0.2
- next 12.1.0
- react-bootstrap 2.2.0
- styled-components 5.3.3
- firebase 9.6.1

### Backend
- SpringBoot 2.5.12
- Gradle 7.4.1

### DB / EC2
- MySQL 8.0.29
- Ubuntu 20.04 LTS
- Nginx 1.18.0
- Jenkins 2.332.2

## 📌 배포(빌드) 시 특이사항
외부 서비스 API Key 및 DB 접속 정보가 포함된 파일들이 .gitignore 에 등록되어 git 원격 저장소에서 제외됨  
프로젝트 빌드 또는 젠킨스 자동 배포 시 해당 파일들을 미리 경로에 포함해야 함

`backend/spring/src/main/resources/application.yaml`  
![spring](https://user-images.githubusercontent.com/50658153/162027359-d922b0f2-4b7b-4931-96a6-448aad238042.png)

<details>
<summary>application.yaml</summary>
<div markdown="1">

```yaml
server:
  port: 8080
  servlet:
    context-path: /
    encoding:
      charset: UTF-8
      enabled: true
      force: true

spring:

  datasource:
    url: jdbc:mysql://k6c107.p.ssafy.io:3306/proma?serverTimezone=Asia/Seoul&characterEncoding=UTF-8
    username: "USER_NAME"
    password: "PASSWORD"
    driver-class-name: com.mysql.cj.jdbc.Driver

  mail:
    host: smtp.gmail.com
    port: 587
    username: "USER_NAME"
    password: "PASSWORD"
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true

  servlet:
    multipart:
      max-file-size: 5MB
      max-request-size: 5MB

  security:
    oauth2:
      client:
        registration:
          github:
            clientId: "CLIENT_ID"
            clientSecret: "CLIENT_SECRET"

  jpa:
    hibernate:
      ddl-auto: update

  properties:
    hibernate:
      format_sql: true

  freemarker:
    cache: false
    suffix: .ftl
    template-loader-path: classpath:/templates

cloud:
  aws:
    credentials:
      access-key: "ACCESS_KEY"
      secret-key: "SECRET_KEY"
    s3:
      bucket: "BUCKET"
    region:
      static: ap-northeast-2 # 리전 정보
    stack:
      auto: false

logging.level:
  org.hibernate.SQL: debug
  com.ssafy.proma : debug
```

</div>
</details>

## ⭐ AWS EC2 설치 항목
- Nginx 1.18.0
- MySQL 8.0.29
- openjdk version "11.0.15”
- node v14.19.2
- npm 6.14.17
- Jenkins 2.332.2
- certbot 0.40.0

## Jenkins 설정
EC2에 젠킨스 설치 후 포트 변경(8080 → 8090)  
GitLab 프로젝트 Webhooks 생성 후 Execute shell 명령어 작성
```
#!/bin/bash -li
BUILD_ID=dontKillMe

cd proma
chmod +x gradlew
./gradlew clean build

fuser -k 8080/tcp

nohup java -jar -Duser.timezone=Asia/Seoul /var/lib/jenkins/workspace/Proma/proma/build/libs/proma-0.0.1-SNAPSHOT.jar &
```
```
cd frontend/proma

npm install
npm install react-is
npm run build

fuser -k 3000/tcp

BUILD_ID=dontKillMe nohup npm run start &
```

## Nginx 설정
SSL 인증서 발급 후 설정
```
server {

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /var/www/html;

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;
        server_name k6c107.p.ssafy.io; # managed by Certbot

        location / {
            # First attempt to serve request as file, then
            # as directory, then fall back to displaying a 404.
            #try_files $uri $uri/ =404;

            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-NginX-Proxy true;

            proxy_pass http://localhost:3000;

            proxy_redirect off;
            charset utf-8;

            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location /api/ {

                proxy_set_header Host $http_host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-NginX-Proxy true;

                proxy_pass http://localhost:8080/;

                proxy_redirect off;
                charset utf-8;

                # WebSocket support
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";

        }

        # pass PHP scripts to FastCGI server
        #
        #location ~ \.php$ {
        #       include snippets/fastcgi-php.conf;
        #
        #       # With php-fpm (or other unix sockets):
        #       fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        #       # With php-cgi (or other tcp sockets):
        #       fastcgi_pass 127.0.0.1:9000;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #       deny all;
        #}

    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/k6c107.p.ssafy.io/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/k6c107.p.ssafy.io/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = k6c107.p.ssafy.io) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


        listen 80 ;
        listen [::]:80 ;
    server_name k6c107.p.ssafy.io;
    return 404; # managed by Certbot
}
```

## MySQL 접속 정보
```
url: jdbc:mysql://k6c107.p.ssafy.io:3306/proma?serverTimezone=Asia/Seoul&characterEncoding=UTF-8
username: proma
password: ssafyk6c107proma
```
